
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover"
    />
    <title>ViviApp – Account Action</title>

    <style>
      :root {
        --bg: #0b0f12;
        --card: #11171c;
        --text: #e9eef2;
        --muted: rgba(233, 238, 242, 0.7);
        --primary: #35c28d;
        --danger: #ff5a5f;
        --border: rgba(233, 238, 242, 0.12);
        --shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
        --radius: 18px;
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: radial-gradient(1200px 800px at 20% 0%, rgba(53,194,141,0.18), transparent 60%),
                    radial-gradient(1000px 700px at 80% 20%, rgba(53,194,141,0.12), transparent 55%),
                    var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 24px;
      }

      .wrap {
        width: 100%;
        max-width: 520px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
      }
      .logo {
        width: 44px;
        height: 44px;
        border-radius: 16px;
        background: rgba(53,194,141,0.18);
        display: grid;
        place-items: center;
        box-shadow: 0 10px 24px rgba(0,0,0,0.25);
      }
      .logo svg {
        width: 22px;
        height: 22px;
        fill: var(--primary);
      }
      .brand h1 {
        font-size: 18px;
        margin: 0;
        font-weight: 850;
        letter-spacing: 0.2px;
      }
      .brand p {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
      }

      .card {
        background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px;
      }

      .title {
        font-size: 18px;
        font-weight: 900;
        margin: 0 0 8px 0;
      }
      .subtitle {
        margin: 0 0 16px 0;
        color: var(--muted);
        line-height: 1.45;
        font-size: 14px;
      }

      .status {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.03);
        margin-bottom: 14px;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--primary);
        box-shadow: 0 0 0 6px rgba(53,194,141,0.14);
      }
      .dot.error {
        background: var(--danger);
        box-shadow: 0 0 0 6px rgba(255,90,95,0.14);
      }
      .status b {
        font-weight: 900;
      }
      .status span {
        color: var(--muted);
        font-size: 14px;
      }

      .form {
        display: none;
        margin-top: 12px;
      }

      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin: 12px 0 6px;
      }

      input {
        width: 100%;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(0,0,0,0.25);
        color: var(--text);
        outline: none;
        font-size: 15px;
      }
      input:focus {
        border-color: rgba(53,194,141,0.45);
        box-shadow: 0 0 0 5px rgba(53,194,141,0.12);
      }

      .row {
        display: flex;
        gap: 12px;
        margin-top: 14px;
        flex-wrap: wrap;
      }

      button, a.btn {
        appearance: none;
        border: 0;
        cursor: pointer;
        border-radius: 14px;
        padding: 12px 14px;
        font-weight: 850;
        font-size: 14px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      button.primary {
        background: var(--primary);
        color: #062217;
        flex: 1;
      }

      button.secondary, a.btn.secondary {
        background: rgba(255,255,255,0.06);
        color: var(--text);
        border: 1px solid var(--border);
      }

      .hint {
        margin-top: 12px;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.45;
      }

      .tiny {
        margin-top: 16px;
        text-align: center;
        color: rgba(233,238,242,0.55);
        font-size: 12px;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- TODO: Replace this SVG with your real ViviApp logo (SVG or <img src="...">). -->
          <!-- simple leaf icon -->
          <svg viewBox="0 0 24 24">
            <path
              d="M20.2 3.8C13.7 4 9.4 6.8 7 10c-2.6 3.5-3.2 8.2-3 10.2 2.1.2 6.7-.4 10.2-3 3.2-2.4 6-6.7 6.2-13.4ZM9.8 14.2c1.9-2.6 5.6-5.2 9.1-6.1-1 3.5-3.5 7.1-6.1 9.1-2.1 1.6-4.9 2.3-6.6 2.4.1-1.7.8-4.5 2.4-6.6Z"
            />
          </svg>
        </div>
        <div>
          <h1 id="brandTitle">ViviApp</h1>
          <p id="brandSubtitle">Account action</p>
        </div>
      </div>

      <div class="card">
        <h2 class="title" id="title">Processing…</h2>
        <p class="subtitle" id="subtitle">
          Please wait a moment.
        </p>

        <div class="status" id="statusBox" role="status" aria-live="polite">
          <div class="dot" id="statusDot"></div>
          <div>
            <b id="statusHeadline">Working</b><br />
            <span id="statusText">Loading action…</span>
          </div>
        </div>

        <div class="form" id="resetForm">
          <label id="newPassLabel" for="newPassword">New password</label>
          <input id="newPassword" type="password" autocomplete="new-password" />

          <label id="confirmPassLabel" for="confirmPassword">Confirm password</label>
          <input
            id="confirmPassword"
            type="password"
            autocomplete="new-password"
          />

          <div class="row">
            <button class="primary" id="resetBtn" type="button">
              Reset password
            </button>
            <a class="btn secondary" id="openAppBtn" href="#" role="button">
              Open ViviApp
            </a>
          </div>

          <p class="hint" id="resetHint">
            After resetting your password, return to the ViviApp app and log in with your new credentials.
          </p>
        </div>

        <div class="row" id="successActions" style="display:none;">
          <a class="btn secondary" id="openAppBtn2" href="#" role="button">
            Open ViviApp
          </a>
        </div>

        <p class="tiny" id="footerTiny">
          You can close this page after finishing.
        </p>
      </div>
    </div>

    <!-- Firebase (Modular v10+) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
      import {
        getAuth,
        applyActionCode,
        verifyPasswordResetCode,
        confirmPasswordReset,
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

      // ----------------------------
      // 1) CONFIG: Fill these values
      // ----------------------------
      const firebaseConfig = {
        apiKey: "REPLACE_ME",
        authDomain: "REPLACE_ME", // e.g. your-project-id.firebaseapp.com
        projectId: "REPLACE_ME",
        appId: "REPLACE_ME",
      };

      // ----------------------------
      // 2) Locale + Strings
      // ----------------------------
      const params = new URLSearchParams(window.location.search);
      const localeRaw = (params.get("locale") || "").toLowerCase().trim();
      const locale = localeRaw === "es" || localeRaw === "en" ? localeRaw : "en";

      const STR = {
        en: {
          brandSubtitle: "Account action",
          titleProcessing: "Processing…",
          subtitleProcessing: "Please wait a moment.",

          statusWorking: "Working",
          statusLoading: "Loading action…",

          missingParamsTitle: "Link is incomplete",
          missingParamsText:
            "This link is missing information. Please request a new email and try again.",

          verifyTitle: "Verify email",
          verifySubtitle:
            "We’re verifying your email. You’ll be able to return to ViviApp right after.",
          verifyOkTitle: "Email verified",
          verifyOkText:
            "Your email has been verified. You can now return to the ViviApp and sign in.",
          verifyErrorTitle: "Verification failed",
          verifyErrorText:
            "This verification link may be expired or already used. Please request a new one from the app.",

          resetTitle: "Reset password",
          resetSubtitle:
            "Create a new password for your account.",
          resetReadyTitle: "Ready",
          resetReadyText: "Please enter your new password.",
          resetOkTitle: "Password updated",
          resetOkText:
            "You can now return to the ViviApp and sign in.",
          resetErrorTitle: "Reset failed",
          resetErrorText:
            "This reset link may be expired or already used. Please request a new reset email from the app.",

          newPassLabel: "New password",
          confirmPassLabel: "Confirm password",
          resetBtn: "Reset password",
          openApp: "Open ViviApp",
          resetHint:
            "After resetting your password, return to the ViviApp app and log in with your new credentials.",

          passTooShort:
            "Password must be at least 6 characters.",
          passNoMatch:
            "Passwords do not match.",
          genericError:
            "Something went wrong. Please try again.",
          footerTiny:
            "You can close this page after finishing.",
        },

        es: {
          brandSubtitle: "Acción de cuenta",
          titleProcessing: "Procesando…",
          subtitleProcessing: "Espera un momento, por favor.",

          statusWorking: "Trabajando",
          statusLoading: "Cargando acción…",

          missingParamsTitle: "El enlace está incompleto",
          missingParamsText:
            "Este enlace no tiene la información necesaria. Solicita un nuevo correo e intenta nuevamente.",

          verifyTitle: "Verificar correo",
          verifySubtitle:
            "Estamos verificando tu correo. Luego podrás volver a ViviApp.",
          verifyOkTitle: "Correo verificado",
          verifyOkText:
            "Ya puedes volver a ViviApp e iniciar sesión.",
          verifyErrorTitle: "No se pudo verificar",
          verifyErrorText:
            "Este enlace puede haber expirado o ya fue utilizado. Solicita uno nuevo desde la app.",

          resetTitle: "Restablecer contraseña",
          resetSubtitle:
            "Crea una nueva contraseña para tu cuenta.",
          resetReadyTitle: "Listo",
          resetReadyText: "Ingresa tu nueva contraseña.",
          resetOkTitle: "Contraseña actualizada",
          resetOkText:
            "Ya puedes volver a ViviApp e iniciar sesión.",
          resetErrorTitle: "No se pudo restablecer",
          resetErrorText:
            "Este enlace puede haber expirado o ya fue utilizado. Solicita un nuevo correo de restablecimiento desde la app.",

          newPassLabel: "Nueva contraseña",
          confirmPassLabel: "Confirmar contraseña",
          resetBtn: "Restablecer contraseña",
          openApp: "Abrir ViviApp",
          resetHint:
            "Después de restablecer tu contraseña, vuelve a la app ViviApp e inicia sesión con tus nuevas credenciales.",

          passTooShort:
            "La contraseña debe tener al menos 6 caracteres.",
          passNoMatch:
            "Las contraseñas no coinciden.",
          genericError:
            "Ocurrió un error. Intenta nuevamente.",
          footerTiny:
            "Puedes cerrar esta página cuando termines.",
        },
      }[locale];

      // ----------------------------
      // 3) Simple UI helpers
      // ----------------------------
      const el = (id) => document.getElementById(id);

      function setText(id, value) {
        const node = el(id);
        if (node) node.textContent = value;
      }

      function setError(isError) {
        const dot = el("statusDot");
        if (dot) dot.classList.toggle("error", !!isError);
      }

      function showResetForm(show) {
        el("resetForm").style.display = show ? "block" : "none";
      }

      function showSuccessActions(show) {
        el("successActions").style.display = show ? "flex" : "none";
      }

      function setStatus(headline, text, isError = false) {
        setError(isError);
        setText("statusHeadline", headline);
        setText("statusText", text);
      }

      function setTop(title, subtitle) {
        setText("title", title);
        setText("subtitle", subtitle);
      }

      // ----------------------------
      // 4) “Open app” link (MVP)
      // ----------------------------
      // If you already have a custom scheme, replace this with yours.
      // Example: viviapp://login
      const APP_DEEPLINK = "viviapp://login";

      function wireOpenAppButtons() {
        const b1 = el("openAppBtn");
        const b2 = el("openAppBtn2");
        if (b1) b1.href = APP_DEEPLINK;
        if (b2) b2.href = APP_DEEPLINK;
        setText("openAppBtn", STR.openApp);
        setText("openAppBtn2", STR.openApp);
      }

      // ----------------------------
      // 5) Initialize and handle mode
      // ----------------------------
      function initStaticCopy() {
        setText("brandSubtitle", STR.brandSubtitle);
        setText("footerTiny", STR.footerTiny);
        setText("newPassLabel", STR.newPassLabel);
        setText("confirmPassLabel", STR.confirmPassLabel);
        setText("resetBtn", STR.resetBtn);
        setText("resetHint", STR.resetHint);

        setTop(STR.titleProcessing, STR.subtitleProcessing);
        setStatus(STR.statusWorking, STR.statusLoading, false);

        wireOpenAppButtons();
      }

      initStaticCopy();

      let app, auth;
      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
      } catch (e) {
        setTop("Config error", "Firebase config is missing or invalid.");
        setStatus("Error", String(e), true);
        showResetForm(false);
        showSuccessActions(false);
        throw e;
      }

      const mode = (params.get("mode") || "").trim();
      const oobCode = (params.get("oobCode") || "").trim();

      if (!mode || !oobCode) {
        setTop(STR.missingParamsTitle, STR.missingParamsText);
        setStatus("Error", STR.missingParamsText, true);
        showResetForm(false);
        showSuccessActions(false);
      } else if (mode === "verifyEmail") {
        // VERIFY EMAIL
        setTop(STR.verifyTitle, STR.verifySubtitle);
        setStatus(STR.statusWorking, STR.statusLoading, false);

        try {
          await applyActionCode(auth, oobCode);
          setTop(STR.verifyOkTitle, STR.verifyOkText);
          setStatus(STR.verifyOkTitle, STR.verifyOkText, false);
          showResetForm(false);
          showSuccessActions(true);
        } catch (e) {
          console.error(e);
          setTop(STR.verifyErrorTitle, STR.verifyErrorText);
          setStatus(STR.verifyErrorTitle, STR.verifyErrorText, true);
          showResetForm(false);
          showSuccessActions(false);
        }
      } else if (mode === "resetPassword") {
        // RESET PASSWORD
        setTop(STR.resetTitle, STR.resetSubtitle);

        try {
          // Validate code before showing form
          await verifyPasswordResetCode(auth, oobCode);

          setStatus(STR.resetReadyTitle, STR.resetReadyText, false);
          showResetForm(true);
          showSuccessActions(false);

          const newPass = el("newPassword");
          const confirmPass = el("confirmPassword");
          const btn = el("resetBtn");

          btn.addEventListener("click", async () => {
            const p1 = (newPass.value || "").trim();
            const p2 = (confirmPass.value || "").trim();

            if (p1.length < 6) {
              setStatus(STR.resetErrorTitle, STR.passTooShort, true);
              return;
            }
            if (p1 !== p2) {
              setStatus(STR.resetErrorTitle, STR.passNoMatch, true);
              return;
            }

            btn.disabled = true;
            setStatus(STR.statusWorking, STR.statusLoading, false);

            try {
              await confirmPasswordReset(auth, oobCode, p1);
              setTop(STR.resetOkTitle, STR.resetOkText);
              setStatus(STR.resetOkTitle, STR.resetOkText, false);
              showResetForm(false);
              showSuccessActions(true);
            } catch (e) {
              console.error(e);
              setStatus(STR.resetErrorTitle, STR.resetErrorText, true);
            } finally {
              btn.disabled = false;
            }
          });
        } catch (e) {
          console.error(e);
          setTop(STR.resetErrorTitle, STR.resetErrorText);
          setStatus(STR.resetErrorTitle, STR.resetErrorText, true);
          showResetForm(false);
          showSuccessActions(false);
        }
      } else {
        // Unknown mode
        setTop(STR.missingParamsTitle, STR.missingParamsText);
        setStatus("Error", STR.missingParamsText, true);
        showResetForm(false);
        showSuccessActions(false);
      }
    </script>
  </body>
</html>
